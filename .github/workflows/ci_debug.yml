# .github/workflows/bulletproof-ci.yml
name: Bulletproof CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install ALL dependencies
      run: |
        python -m pip install --upgrade pip
        
        # Core dependencies
        pip install aiofiles
        
        # Testing dependencies
        pip install pytest pytest-asyncio
        
        # Build tools (just in case)
        pip install setuptools wheel
        
        echo "‚úÖ All dependencies installed!"

    - name: Create minimal setup.py
      run: |
        cat > setup.py << 'EOF'
        from setuptools import setup, find_packages
        
        setup(
            name="simpleenvs",
            version="1.0.4",
            packages=find_packages(where="src"),
            package_dir={"": "src"},
            install_requires=[
                "aiofiles>=0.8.0",
            ],
        )
        EOF
        
        echo "‚úÖ Setup.py created!"

    - name: Install package (multiple attempts)
      run: |
        echo "üîß Attempting package installation..."
        
        # Method 1: Standard editable install
        if pip install -e . 2>&1; then
          echo "‚úÖ Method 1: pip install -e . succeeded"
          INSTALL_METHOD="pip"
        else
          echo "‚ùå Method 1 failed, trying method 2..."
          
          # Method 2: PYTHONPATH
          export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"
          echo "PYTHONPATH=${PYTHONPATH}:$(pwd)/src" >> $GITHUB_ENV
          echo "‚úÖ Method 2: PYTHONPATH setup completed"
          INSTALL_METHOD="pythonpath"
        fi
        
        echo "INSTALL_METHOD=$INSTALL_METHOD" >> $GITHUB_ENV

    - name: Test import (robust)
      run: |
        python -c "
        import sys
        import os
        
        # Add paths just in case
        sys.path.insert(0, './src')
        sys.path.insert(0, '.')
        
        print('üêç Python version:', sys.version)
        print('üìÅ Python path:', sys.path[:3], '...')
        
        # Try different import methods
        success = False
        module = None
        
        # Try 1: simpleenvs
        try:
            import simpleenvs
            print('‚úÖ Import simpleenvs: SUCCESS')
            module = simpleenvs
            success = True
        except ImportError as e:
            print(f'‚ùå Import simpleenvs failed: {e}')
        
        # Try 2: simpleenvs_python
        if not success:
            try:
                import simpleenvs_python
                print('‚úÖ Import simpleenvs_python: SUCCESS')
                module = simpleenvs_python
                success = True
            except ImportError as e:
                print(f'‚ùå Import simpleenvs_python failed: {e}')
        
        if not success:
            print('‚ùå All import methods failed!')
            print('Available in src:')
            if os.path.exists('./