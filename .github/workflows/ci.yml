# .github/workflows/ci.yml
name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
        exclude:
          # Reduce CI time by skipping some combinations
          - os: windows-latest
            python-version: "3.8"
          - os: macos-latest
            python-version: "3.8"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install core dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiofiles

    - name: Setup Python path
      shell: bash
      run: |
        echo "PYTHONPATH=$PYTHONPATH:$(pwd)/src" >> $GITHUB_ENV
        # Fix Windows encoding issues
        echo "PYTHONIOENCODING=utf-8" >> $GITHUB_ENV
        echo "PYTHONUTF8=1" >> $GITHUB_ENV

    - name: Test import and basic functionality
      shell: bash
      run: |
        python -c "
        import sys
        sys.path.insert(0, './src')
        
        print('Python version:', sys.version)
        print('Platform:', sys.platform)
        
        try:
            import simpleenvs
            print('simpleenvs import successful!')
            
            # Check version
            if hasattr(simpleenvs, '__version__'):
                print('Version:', simpleenvs.__version__)
            elif hasattr(simpleenvs, 'constants'):
                print('Version:', simpleenvs.constants.VERSION)
            else:
                print('Version info not found, but import works!')
            
            # Test basic functionality
            import tempfile, os
            
            # Test load_dotenv if available
            if hasattr(simpleenvs, 'load_dotenv'):
                print('Testing load_dotenv...')
                
                with tempfile.NamedTemporaryFile(mode='w', suffix='.env', delete=False) as f:
                    f.write('TEST_VAR=hello\\nDEBUG=true\\nPORT=8080\\n')
                    env_file = f.name
                
                try:
                    simpleenvs.load_dotenv(env_file)
                    
                    if os.getenv('TEST_VAR') == 'hello':
                        print('Environment loading works!')
                    else:
                        print('Environment variables not loaded properly')
                        
                except Exception as e:
                    print('Function test failed:', str(e))
                finally:
                    os.unlink(env_file)
            else:
                print('load_dotenv not found')
                available_funcs = [x for x in dir(simpleenvs) if not x.startswith('_')]
                print('Available functions:', available_funcs[:10])
            
            print('All tests passed for Python ${{ matrix.python-version }} on ${{ matrix.os }}!')
            
        except ImportError as e:
            print('Import failed:', str(e))
            import os
            if os.path.exists('./src'):
                print('src/ contents:', os.listdir('./src'))
            sys.exit(1)
        except Exception as e:
            print('Unexpected error:', str(e))
            sys.exit(1)
        "

    - name: Test async functionality (if supported)
      shell: bash
      run: |
        python -c "
        import sys
        sys.path.insert(0, './src')
        import simpleenvs
        import asyncio
        import tempfile
        import os
        
        async def test_async():
            try:
                if hasattr(simpleenvs, 'load') or hasattr(simpleenvs, 'aload_dotenv'):
                    print('Testing async functionality...')
                    
                    with tempfile.NamedTemporaryFile(mode='w', suffix='.env', delete=False) as f:
                        f.write('ASYNC_TEST=async_works\\n')
                        env_file = f.name
                    
                    try:
                        if hasattr(simpleenvs, 'load'):
                            await simpleenvs.load(env_file)
                        elif hasattr(simpleenvs, 'aload_dotenv'):
                            await simpleenvs.aload_dotenv(env_file)
                        
                        print('Async loading works!')
                    except Exception as e:
                        print('Async test failed:', str(e))
                    finally:
                        os.unlink(env_file)
                else:
                    print('No async functions found')
            except Exception as e:
                print('Async test error:', str(e))
        
        try:
            asyncio.run(test_async())
        except Exception as e:
            print('Could not run async test:', str(e))
        "

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine aiofiles

    - name: Verify package can be imported before build
      run: |
        export PYTHONPATH="$PYTHONPATH:$(pwd)/src"
        python -c "
        import sys
        sys.path.insert(0, './src')
        import simpleenvs
        print('✅ Package imports successfully before build')
        "

    - name: Build package
      run: |
        python -m build
        echo "✅ Package built successfully!"

    - name: Check package
      run: |
        twine check dist/*
        echo "✅ Package check passed!"

    - name: Test wheel installation
      run: |
        # Install the wheel
        pip install dist/*.whl
        
        # Test import after installation
        python -c "
        try:
            import simpleenvs
            print('✅ Wheel installation and import successful!')
        except ImportError as e:
            print(f'❌ Wheel import failed: {e}')
            exit(1)
        "

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-${{ github.sha }}
        path: dist/
        retention-days: 30